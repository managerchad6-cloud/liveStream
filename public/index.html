<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LiveStream Chatbox MVP</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #1a1a1a;
      color: #e0e0e0;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }

    .main-container {
      display: flex;
      height: 100vh;
      gap: 20px;
      padding: 20px;
    }

    .viewport-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 0;
    }

    #viewport {
      width: 100%;
      aspect-ratio: 16 / 9;
      background-color: #0a0a0a;
      border: 2px solid #404040;
      border-radius: 8px;
    }

    .chat-container {
      width: 400px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    h1 {
      margin: 0;
      color: #ffffff;
      font-size: 24px;
    }

    #messageHistory {
      background: #2d2d2d;
      border: 1px solid #404040;
      border-radius: 8px;
      padding: 20px;
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 4px;
      color: #e0e0e0;
    }

    .user-message {
      background-color: #1e3a5f;
      text-align: right;
      color: #ffffff;
    }

    .status-message {
      background-color: #4a3d1f;
      text-align: center;
      font-style: italic;
      color: #ffd700;
    }

    .chatbox-container {
      display: flex;
      gap: 10px;
    }

    #chatbox {
      flex: 1;
      padding: 12px;
      border: 1px solid #404040;
      border-radius: 4px;
      font-size: 16px;
      background-color: #2d2d2d;
      color: #e0e0e0;
    }

    #chatbox:focus {
      outline: none;
      border-color: #007bff;
    }

    #chatbox::placeholder {
      color: #888;
    }

    #submitBtn {
      padding: 12px 24px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    #submitBtn:hover {
      background-color: #0056b3;
    }

    #submitBtn:disabled {
      background-color: #404040;
      color: #666;
      cursor: not-allowed;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .control-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .control-row label {
      color: #888;
      font-size: 14px;
      min-width: 80px;
    }

    .control-row select {
      padding: 8px 12px;
      border: 1px solid #404040;
      border-radius: 4px;
      background-color: #2d2d2d;
      color: #e0e0e0;
      font-size: 14px;
      cursor: pointer;
    }

    .control-row select:focus {
      outline: none;
      border-color: #007bff;
    }

    .control-row input[type="range"] {
      flex: 1;
      accent-color: #007bff;
    }

    .control-row .value {
      color: #e0e0e0;
      font-size: 14px;
      min-width: 35px;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="viewport-container">
      <div id="viewport"></div>
    </div>
    
    <div class="chat-container">
      <h1>Chatbox MVP</h1>
      
      <div class="controls">
        <div class="control-row">
          <label for="voiceSelect">Voice:</label>
          <select id="voiceSelect">
            <option value="chad">Chad</option>
            <option value="virgin">Virgin</option>
          </select>
        </div>
        <div class="control-row">
          <label for="modelSelect">Model:</label>
          <select id="modelSelect">
            <option value="eleven_v3">v3 (Expressive)</option>
            <option value="eleven_turbo_v2">v2 Turbo (Fast)</option>
          </select>
        </div>
        <div class="control-row">
          <label for="tempSlider">Temp:</label>
          <input type="range" id="tempSlider" min="0" max="1" step="0.1" value="0.7">
          <span class="value" id="tempValue">0.7</span>
        </div>
      </div>
      
      <div id="messageHistory"></div>
      
      <div class="chatbox-container">
        <input 
          type="text" 
          id="chatbox" 
          placeholder="Type your message here..."
          autocomplete="off"
        />
        <button id="submitBtn">Submit</button>
      </div>
    </div>
  </div>

  <script>
    const chatbox = document.getElementById('chatbox');
    const submitBtn = document.getElementById('submitBtn');
    const messageHistory = document.getElementById('messageHistory');
    const voiceSelect = document.getElementById('voiceSelect');
    const modelSelect = document.getElementById('modelSelect');
    const tempSlider = document.getElementById('tempSlider');
    const tempValue = document.getElementById('tempValue');

    tempSlider.addEventListener('input', () => {
      tempValue.textContent = tempSlider.value;
    });

    function addMessage(text, isUser, isStatus = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user-message' : isStatus ? 'status-message' : ''}`;
      messageDiv.textContent = text;
      messageHistory.appendChild(messageDiv);
      messageHistory.scrollTop = messageHistory.scrollHeight;
    }

    function isSlashCommand(text) {
      return typeof text === 'string' && text.trim().startsWith('/') && text.trim().length > 1;
    }

    async function sendMessage() {
      const message = chatbox.value.trim();
      
      if (!message) {
        return;
      }

      // Disable input while processing
      chatbox.disabled = true;
      submitBtn.disabled = true;

      // Display user message
      addMessage(message, true);
      addMessage(isSlashCommand(message) ? 'Recording vote...' : 'Generating response...', false, true);
      chatbox.value = '';

      try {
        if (isSlashCommand(message)) {
          const response = await fetch('/api/commands', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ command: message }),
          });

          const data = await response.json().catch(() => ({}));
          if (!response.ok) {
            throw new Error(data.error || 'Failed to record command');
          }

          const statusEl = messageHistory.querySelector('.status-message');
          if (statusEl) {
            statusEl.remove();
          }
          addMessage(`Vote registered: ${data.command} (${data.count})`, false, true);
          return;
        }

        const response = await fetch('/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message,
            voice: voiceSelect.value,
            model: modelSelect.value,
            temperature: parseFloat(tempSlider.value)
          }),
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Failed to get response' }));
          throw new Error(errorData.error || 'Failed to get response');
        }

        // Get audio blob
        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        
        // Remove status message
        const statusMsg = messageHistory.querySelector('.status-message');
        if (statusMsg) {
          statusMsg.remove();
        }

        // Create and play audio
        const audio = new Audio(audioUrl);
        audio.play();
        
        // Clean up URL after playback
        audio.addEventListener('ended', () => {
          URL.revokeObjectURL(audioUrl);
        });

        addMessage('Playing response...', false, true);
      } catch (error) {
        // Remove status message
        const statusMsg = messageHistory.querySelector('.status-message');
        if (statusMsg) {
          statusMsg.remove();
        }
        addMessage(`Error: ${error.message}`, false, true);
      } finally {
        // Re-enable input
        chatbox.disabled = false;
        submitBtn.disabled = false;
        chatbox.focus();
      }
    }

    // Submit on button click
    submitBtn.addEventListener('click', sendMessage);

    // Submit on Enter key
    chatbox.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Focus chatbox on load
    chatbox.focus();
  </script>
</body>
</html>
